#!/bin/bash

# Step 1: Get clean matches from Puppeteer output
raw=$(node scrolllink.js 'https://www.flipkart.com/travel/flights/search?trips=BLR-BOM-25042025&travellers=1-0-0&class=e&tripType=ONE_WAY&isIntl=false&source=Search%20Modify%20Form' |
  grep -oP 'â‚¹[0-9,]+|[0-9]{2}:[0-9]{2}|[A-Z]{2}-\d{3,4}|(?:Air India|Akasa Air|IndiGo|Vistara|SpiceJet|Go First)|\d+h \d+m' |
  grep -v 'Non stop')

# Optional: log to debug.txt
echo "$raw" > debug.txt

# Confirm IndiGo is present
echo "Debug: Matching IndiGo flights..."
grep 'IndiGo' debug.txt

# Convert to array
mapfile -t lines <<< "$raw"

# Header
printf "%-12s %-20s %-8s %-9s %-8s %-10s %-10s %-5s\n" "Airline" "Flight(s)" "DepTime" "Duration" "Arrival" "Price" "Discount" "Tax"

# Step 3: Parse logic
flight_buffer=()
i=0

while [ $i -lt ${#lines[@]} ]; do
    item="${lines[$i]}"

    if [[ "$item" =~ ^(Air\ India|Akasa\ Air|IndiGo|Vistara|SpiceJet|Go\ First)$ ]]; then
        airline="$item"
        flight_buffer=()
        j=1

        # Collect flight codes
        while [[ "${lines[$((i+j))]}" =~ ^[A-Z]{2}-[0-9]{3,4}$ ]]; do
            flight_buffer+=("${lines[$((i+j))]}")
            j=$((j+1))
        done

        flight="$(IFS=, ; echo "${flight_buffer[*]}")"
        dept="${lines[$((i+j))]}"
        duration="${lines[$((i+j+1))]}"
        arrival="${lines[$((i+j+2))]}"
        price="${lines[$((i+j+3))]}"
        discount="${lines[$((i+j+4))]}"
        tax="${lines[$((i+j+5))]}"

        # Only print if all values are non-empty
        if [[ -n "$flight" && -n "$dept" && -n "$duration" && -n "$arrival" && -n "$price" && -n "$discount" && -n "$tax" ]]; then
            printf "%-12s %-20s %-8s %-9s %-8s %-10s %-10s %-5s\n" "$airline" "$flight" "$dept" "$duration" "$arrival" "$price" "$discount" "$tax"
        fi

        i=$((i + j + 6))
    else
        i=$((i + 1))
    fi
done

